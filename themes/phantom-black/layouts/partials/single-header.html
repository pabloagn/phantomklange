{{/* ============================================================ */}}
{{/* layouts/partials/single-header.html                        */}}
{{/*                                                            */}}
{{/* Displays the header for single work/person pages.          */}}
{{/* Input (.): Dict with:                                      */}}
{{/*   - page (object)                                          */}}
{{/*   - layoutType (string: "work" or "person")                */}}
{{/*   - context (object): The '$' context from caller          */}}
{{/* ============================================================ */}}
{{ $page := .page }}
{{ $layoutType := .layoutType }}
{{ $context := .context }} {{/* This is the '$' from the calling template */}}

{{ $idParam := "" }}
{{ $imageDir := "" }}
{{ $title := $page.Title }}
{{ $fallbackTitleSlug := $page.Title | urlize }}
{{ $workType := $page.Type }}

{{/* Determine ID param and image directory based on type */}}
{{/* A map lookup might be cleaner if this list grows very large */}}
{{ if eq $workType "book" }}{{ $idParam = "book_id" }}{{ $imageDir = "books" }}{{ end }}
{{ if eq $workType "film" }}{{ $idParam = "film_id" }}{{ $imageDir = "films" }}{{ end }}
{{ if eq $workType "painting" }}{{ $idParam = "painting_id" }}{{ $imageDir = "paintings" }}{{ end }}
{{ if eq $workType "scent" }}{{ $idParam = "scent_id" }}{{ $imageDir = "scents" }}{{ end }}
{{ if eq $workType "photograph" }}{{ $idParam = "photograph_id" }}{{ $imageDir = "photographs" }}{{ end }}
{{ if eq $workType "musical_composition" }}{{ $idParam = "composition_id" }}{{ $imageDir = "compositions" }}{{ end }}
{{ if eq $workType "play" }}{{ $idParam = "play_id" }}{{ $imageDir = "plays" }}{{ end }}
{{ if eq $workType "sculpture" }}{{ $idParam = "sculpture_id" }}{{ $imageDir = "sculptures" }}{{ end }}
{{ if eq $workType "print" }}{{ $idParam = "print_id" }}{{ $imageDir = "prints" }}{{ end }}
{{ if eq $workType "graphic_novel" }}{{ $idParam = "graphic_novel_id" }}{{ $imageDir = "graphic_novels" }}{{ end }}
{{ if eq $workType "digital_art" }}{{ $idParam = "digital_art_id" }}{{ $imageDir = "digital_art" }}{{ end }}
{{ if eq $workType "architecture" }}{{ $idParam = "architecture_id" }}{{ $imageDir = "architecture" }}{{ end }}
{{ if eq $workType "installation" }}{{ $idParam = "installation_id" }}{{ $imageDir = "installations" }}{{ end }}
{{ if eq $workType "sound_art" }}{{ $idParam = "sound_art_id" }}{{ $imageDir = "sound_art" }}{{ end }}
{{ if eq $workType "ceramics" }}{{ $idParam = "ceramics_id" }}{{ $imageDir = "ceramics" }}{{ end }}
{{ if eq $workType "fashion_collection" }}{{ $idParam = "collection_id" }}{{ $imageDir = "fashion_collections" }}{{ end }}
{{ if eq $workType "exhibition" }}{{ $idParam = "exhibition_id" }}{{ $imageDir = "exhibitions" }}{{ end }}
{{/* Special case for person type */}}
{{ if eq $workType "person" }}{{ $idParam = "person_id" }}{{ $imageDir = "people" }}{{ end }}


{{ $itemId := "" }}
{{/* Check using 'isset' for safety before 'index' */}}
{{ if and $idParam ($page.Params | isset $idParam) }}
    {{ $itemId = index $page.Params $idParam }}
{{ end }}

{{ $folderName := "" }}
{{ if ne $itemId "" }}
    {{ $folderName = printf "%s-%s" $itemId $fallbackTitleSlug }}
{{ else if ne $imageDir "" }} {{/* Fallback if ID missing but type known */}}
     {{ $folderName = $fallbackTitleSlug }}
{{ end }}

{{ $coverPath := "" }}
{{ $posterPath := "" }}
{{ $hasImages := false }}
{{ if and (ne $imageDir "") (ne $folderName "") }}
    {{/* Construct paths relative to site root */}}
    {{ $coverPath = printf "/images/%s/%s/cover.jpg" $imageDir $folderName }}
    {{ $posterPath = printf "/images/%s/%s/poster.jpg" $imageDir $folderName }}
    {{/* We assume images might exist; onerror handles missing ones */}}
    {{ $hasImages = true }} 
{{ end }}

{{/* --- Logic for Subtitle --- */}}
{{ $subtitle := "" }}
{{ if eq $layoutType "work" }}
    {{ $primaryContributors := slice }}
    {{ range $page.Params.contributors }}
        {{ if partial "is-primary-role.html" .role }}
            {{ $primaryContributors = $primaryContributors | append .person }}
        {{ end }}
    {{ end }}
    {{ $subtitle = delimit ($primaryContributors | uniq) ", " }} 
{{ else if eq $layoutType "person" }}
  {{ $subtitle = $page.Params.description }} {{/* Person uses description */}}
{{ end }}
{{/* --- End Subtitle Logic --- */}}

<div class="header-image" {{ if $hasImages }} style="background-image: url('{{ $coverPath | relURL }}')" {{ else }} style="background-color: var(--bg-secondary); height: 250px;" {{ end }}>
    {{ if $hasImages }}<div class="header-overlay"></div>{{ end }}

    {{ if eq $layoutType "work" }}
        <div class="book-details-container"> {{/* Reusing class name for consistency */}}
            <div class="book-details-inner">
                {{ if $hasImages }}
                <div class="book-poster-container">
                    <img src="{{ $posterPath | relURL }}" alt="{{ $title }} poster" class="book-poster" onerror="this.style.display='none'; this.parentElement.style.display='none';">
                </div>
                {{ end }}
                <div class="book-metadata">
                    <h1 class="book-metadata-title">{{ $title }}</h1>
                    {{ with $subtitle }}
                        <p class="book-metadata-author"> {{/* This subtitle now contains primary contributor names */}}
                            {{ range $index, $personName := $primaryContributors }} {{/* Needs $primaryContributors from subtitle logic */}}
                                {{ $personPage := $context.Site.GetPage (printf "/people/%s" ($personName | urlize)) }}
                                {{ if $personPage }}<a href="{{ $personPage.RelPermalink }}">{{ $personName }}</a>{{ else }}{{ $personName }}{{ end }}
                                {{ if lt $index (sub (len $primaryContributors) 1) }}, {{ end }}
                            {{ end }}
                        </p>
                    {{ end }}
                    {{/* Pass contributors list to metadata display */}}
                    {{ partial "metadata-display.html" (dict "page" $page "context" $context "contributors" $page.Params.contributors) }}
                </div>
            </div>
        </div>
     {{ else if eq $layoutType "person" }}
         <div class="person-details-container">
             <div class="person-details-inner">
                 {{ if $hasImages }}
                 <div class="person-avatar-container">
                     <img src="{{ $posterPath | relURL }}" alt="{{ $title }} portrait" class="person-avatar" onerror="this.style.display='none';">
                 </div>
                 {{ end }}
                 <div class="person-metadata">
                     <h1 class="person-name">{{ $title }}</h1>
                     {{ with $subtitle }} {{/* Uses description here */}}
                         <p class="person-description">{{ . }}</p>
                     {{ end }}
                     <div class="person-meta-details">
                         {{ with $page.Params.birth_date }}<span class="meta-item">Born: {{ . }}</span>{{ end }}
                         {{ with $page.Params.death_date }}{{ if ne . "present" }}<span class="meta-item">Died: {{ . }}</span>{{ else }}<span class="meta-item">Living</span>{{ end }}{{ end }}
                         {{ with $page.Params.nationality }}<span class="meta-item">Nationality: {{ . }}</span>{{ end }}
                     </div>
                 </div>
             </div>
         </div>
     {{ end }}
</div>